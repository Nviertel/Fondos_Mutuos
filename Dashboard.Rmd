---
title: "Fondos Mutuos"
output: 
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bg: white
      fg: "#201E20" 
      primary: "#8A307F"
      base_font: !expr bslib::font_google("Prompt")
      code_font: !expr bslib::font_google("JetBrains Mono")
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r, include = FALSE}
rm(list=ls())
library(shiny)
library(flexdashboard)
library(dplyr)
library(readxl)
library(ggplot2)
library(forcats)
library(plotly)
library(DT)
library(gganimate)
library(tidyr)
library(rsconnect)
options(scipen = 999)
```

```{r base}
df1 <- read.csv2("Bases/datos_v2.csv", sep = ",")
df2 <- read.csv2("Bases/datos_v3.csv", sep = ",") %>%
  filter(FM_FECHA != "2022-02-28")
df3 <- read_xlsx("Bases/fo_series.xlsx")
df <- rbind(df1, df2)
df <- left_join(df, df3, by = c("FM_RUN_FM" = "fo_run"))

df <- df %>% select(2, 17, 18, 3:16) %>% 
  mutate(FM_FECHA = format(as.Date(df$FM_FECHA), "%Y-%m"),
         RG_RAZON_SOCIAL = gsub("ADMINISTRADORA GENERAL DE FONDOS", "AGF", 
                                RG_RAZON_SOCIAL),
         RG_RAZON_SOCIAL = gsub("ADMINISTRADORA  GENERAL DE FONDOS", "AGF", 
                                RG_RAZON_SOCIAL),
         RG_RAZON_SOCIAL = gsub("ASSET MANAGEMENT", "AM", RG_RAZON_SOCIAL),
         RG_RAZON_SOCIAL = as.factor(RG_RAZON_SOCIAL),
         FO_TIPO_FONDO = as.factor(FO_TIPO_FONDO)) %>%
  mutate_at(c("FM_VCUOT", "FM_PNETO", "FM_ACTOT", "PROM", "EUR", "MXN", "PEN"), 
            as.double) %>%
  rename(PESO = X..) %>%
  mutate(FM_VCUOT = ifelse(FM_MONEDA == "PROM", FM_VCUOT*PROM, FM_VCUOT),
         FM_PNETO = ifelse(FM_MONEDA == "PROM", FM_PNETO*PROM, FM_PNETO),
         FM_ACTOT = ifelse(FM_MONEDA == "PROM", FM_ACTOT*PROM, FM_ACTOT))
df <- as.data.frame(df)
remove(df1, df2, df3)

tac <- read_xlsx("Bases/TAC.xlsx")
```



```{r}
lala <- df %>% 
  filter(RG_RAZON_SOCIAL == "AGF SURA S.A.") %>%
  select(RG_RAZON_SOCIAL, fo_nombre, FM_FECHA, FO_TIPO_FONDO) %>%
  distinct()
  

```








Sobre los fondos mutuos {data-navmenu="Inicio"}
======================================================================

Column
----------------------------------------------------------------------

### **¿Qué son los fondos mutuos?** {data-height="620"}

Es un patrimonio integrado por aportes de personas naturales y personas jurídicas, denominadas partícipes o aportantes, para su inversión en valores y bienes que le permita la Ley Única de Fondos (Ley N° 20.712).

El fondo es administrado por cuenta y riesgo de los partícipes, por una sociedad anónima especial, cuyo objeto exclusivo es la administración de recursos de terceros, sin perjuicio de las actividades complementarias a su giro que les puede autorizar la Comisión, de acuerdo a la Ley N° 20.712 y su Reglamento, el Decreto Supremo N° 129 de Hacienda. Su fiscalización corresponde a esta Comisión, la cual autoriza la existencia de la sociedad, que se debe denominar como una Administradora General de Fondos (AGF).

Los Fondos se definen como Fondos Mutuos o Fondos de Inversión. Los Fondos Mutuos son aquellos que permiten el rescate total y permanente de las cuotas, y las pagan en un plazo inferior o igual a 10 días. En cambio, se denominan Fondos de Inversión aquellos fondos que no cumplen la anterior definición.

Los aportes quedan expresados en cuotas del fondo, pudiendo existir distintas series de éstas para un mismo fondo, lo que deberá establecerse en el reglamento interno respectivo, todas de igual valor y características, y su cesión se regirá por las formalidades y procedimientos que establece el reglamento interno del fondo. Las cuotas de una serie de un fondo podrán ser canjeadas por cuotas de otra serie del mismo fondo, rigiéndose por las normas que al respecto se establecen en el reglamento interno.

El fondo deberá contar permanentemente con a lo menos 50 partícipes, salvo que entre éstos haya un inversionista institucional, en cuyo caso no regirá ese número mínimo de partícipes. Del mismo modo, deberá mantener un patrimonio no menor al equivalente a 10.000 unidades de fomento. La administradora lleva un Registro de Partícipes.

### **Relación con la CMF** {data-height="480"}

La CMF autoriza la existencia de las sociedades que administran fondos (AGF) y supervisa que dichas sociedades y los fondos cumplan los requisitos establecidos en la ley y su reglamento, mediante la revisión de su información legal, financiera y contable.

La Comisión podrá examinar sin restricción alguna todos los libros, carteras y documentos de la sociedad administradora y, en general, solicitar todos los datos y antecedentes que le permitan imponerse del estado, desarrollo y solvencia de la administración y de la forma en que cumpla las prescripciones legales, pudiendo ordenar las medidas que fueren necesaria, para corregir las deficiencias que encontrare.

La Comisión podrá revocar la autorización de existencia de la sociedad administradora en los casos de infracción grave a las normas legales que rijan a los Fondos o cuando de las investigaciones que se practiquen resulte que la administración se ha llevado en forma fraudulenta o manifiestamente descuidada.

Los Reglamentos Internos de los fondos se encuentran depositados en el Registro Público de Depósito de Reglamentos Internos.

Column
----------------------------------------------------------------------

### **Sobre su rentabilidad** {data-height="390"}

El beneficio que la inversión en un fondo reportará a los partícipes, será el incremento que se produzca en el valor de la cuota como consecuencia de las variaciones experimentadas por el patrimonio del fondo. El mayor valor que perciban los partícipes en el rescate de cuotas se calculará como la diferencia entre el valor de adquisición y el de rescate. Para tales efectos, el valor de adquisición se expresará en Unidades de Fomento según el valor que ésta represente al día de la adquisición, convirtiéndolas en pesos según el valor de esta misma unidad al día que se efectúe el rescate.

La rentabilidad de los fondos es generada principalmente por dos factores:

Ganancias o pérdidas de capital: se refiere al momento en que los activos que son mantenidos por el fondo cambian su valor, se generan ganancias o pérdidas de capital para el fondo que se ven reflejadas en un mayor o menor valor de la cuota.

Ingresos por dividendos e intereses: corresponden a las ganancias que se generan a los fondos a través de los intereses o dividendos pagados por los instrumentos que mantienen, por ejemplo, inversiones en instrumentos de deuda o acciones de sociedades anónimas.

### **Sobre su riesgo** {data-height="320"}

Los inversionistas a menudo creen que por ser partícipes en distintos fondos, están protegidos del riesgo de mercado. No obstante, hay que tener claro que si los fondos que componen su cartera de inversión tienen las mismas características, la diversificación se habrá diluido y el riesgo se habrá mantenido.

Los fondos están sujetos a distintos tipos de riesgo: riesgo país, riesgo de liquidez, riesgo de tasa de interés, riesgo cambiario. Por ejemplo:

Los fondos de capitalización están sujetos a un riesgo debido a la variación del precio de las acciones. Los fondos que invierten en el mercado internacional están expuestos al riesgo de cambios en la coyuntura económica, financiera, jurídica y política del país en que invierten.

### **Sobre los costos** {data-height="290"}

Al momento de invertir su dinero, la Administradora además de recibir el dinero con el cual usted se vuelve partícipe del Fondo, le cobrará costos asociados a su inversión, que están relacionados con la remuneración de la administración del Fondo, y los costos y comisiones, de acuerdo con los plazos de permanencia de su inversión en el Fondo. En muchos casos, si no retira su dinero durante un periodo determinado, se elimina el cobro de una comisión.

La remuneración de la sociedad por su administración, las comisiones y los gastos atribuibles al fondo, así como la política de inversiones, deben quedar establecidas en el reglamento interno, que se deposita en la CMF.

Column
----------------------------------------------------------------------

### ***Sobre sus inversiones*** {data-height="480"}

Los fondos mutuos tienen portafolios de inversión variados, de modo que se pueden encontrar fondos que invierten en acciones, otros que invierten sólo en títulos de deuda, como bonos, letras hipotecarias o instrumentos del Estado (Pagarés del Banco Central, Bonos de Reconocimiento, Bonos Subordinados), y también están los que invierten en ambos tipos de instrumentos.

A nivel general, los fondos invierten en tres tipos de instrumentos:

a)  **Instrumentos de deuda de corto plazo**: son aquellos valores de oferta pública representativos de deuda, cuyo plazo hasta su total extinción no excede los 365 días a la fecha de valorización del fondo.

b)  **Instrumentos de deuda de mediano y largo plazo**: son aquellos valores de oferta pública representativos de deuda cuyo plazo hasta su total extinción excede los 365 días a la fecha de valorización del fondo.

c)  **Instrumentos de capitalización**: son aquellos valores de oferta pública representativos de capital, tales como acciones de sociedades anónimas abiertas, cuotas de fondos de inversión, cuotas de fondos mutuos, entre otros.

Los fondos mutuos diversifican sus inversiones, es decir, invierten en distintos instrumentos del mercado de capitales, combinando instrumentos de deuda y de renta variable de diferentes emisores. La diversificación no sólo se logra eligiendo diferentes activos de una misma clase, sino que varios activos de distinta clase de riesgo; países, sectores industriales y plazos de inversión.

A los fondos también es posible identificarlos según el mercado en el que invierten: nacional, internacional o emergente, países desarrollados o multinacionales, en contratos de derivados tanto bursátiles como extrabursátiles, entre otros. Esto es de gran importancia debido a que los niveles de riesgo y retorno fluctúan entre los diferentes mercados. De acuerdo con lo definido por su política de inversiones, pueden invertir hasta el 100% de su cartera de activos en títulos extranjeros.

De acuerdo con las características descritas, los fondos mutuos se clasifican en ocho tipos (ver más información):

1.  **De inversión en instrumentos de deuda de corto plazo con duración menor o igual a 90 días**: instrumentos de deuda de corto plazo y en instrumentos de deuda de mediano y largo plazo. Duración de la cartera de inversiones: debe ser menor o igual a 90 días.

2.  **De inversión en instrumentos de deuda de corto plazo con duración menor o igual a 365 días**: instrumentos de deuda de corto plazo y en instrumentos de deuda de mediano y largo plazo. Duración de la cartera de inversiones: debe ser menor o igual a los 365 días.

3.  **De inversión en instrumentos de deuda de mediano y largo plazo**: instrumentos de deuda de corto plazo e instrumentos de deuda de mediano y largo plazo. Duración de la cartera de inversiones: debe ser superior a los 365 días.

4.  **Mixto**: instrumentos de deuda de corto, mediano y largo plazo e instrumentos de capitalización. Al momento de definirse estos fondos, deberán expresar los porcentajes máximos y mínimos de sus activos que se invertirán en instrumentos de capitalización. En todo caso, la diferencia entre dichos porcentajes no podrá ser superior al 50% de los activos del fondo.

5.  **De inversión en instrumentos de capitalización**: instrumentos de deuda de corto plazo, instrumentos de deuda de mediano y largo plazo y mayoritariamente en instrumentos de capitalización (al menos 90% de los activos del fondo).

6.  **De libre inversión**: su política es de libre inversión, que si bien no se encuentra normada debe establecerse en el reglamento interno.

7.  **Estructurado**: busca la obtención de una rentabilidad previamente determinada, fija (nominal o real) y/o variable.

8.  **Dirigido a inversionistas calificados**: se encuentran dirigidos a inversionistas calificados y pueden definir libremente su política de inversión.

### Total de activos como proporción del PIB

```{r}
valueBox("15%", 
         icon = "fa-money")
```

Sobre las AGF {data-navmenu="Inicio"}
======================================================================

Column {data-width="500"}
----------------------------------------------------------------------

### **¿Que son las Administradoras Generales de Fondos?** {data-height="350"}

Las Administradoras Generales de Fondos son demandantes de valores, a través de los fondos y carteras de terceros que administran.

Son sociedades anónimas especiales que se constituyen para la administración de recursos de terceros a través de Fondos Mutuos, Fondos de Inversión y Carteras de Terceros (de aquellas sometidas a la fiscalización de esta Comisión), regidos por la Ley N° 20.712.

Las administradoras son responsables por la administración de los recursos de los fondos, por cuenta y riesgo de los aportantes.

Por la gestión de los fondos, las administradoras pueden cobrar a estos aquella remuneración que establecen los reglamentos internos de cada uno de ellos.


### Administradoras Generales de Fondo (ACAFI) CORREGIR POR LA AAFM!! {data-height="650"}

```{r picture, echo = F, out.width = '100%'}
knitr::include_graphics("/Users/nicolasviertel/Desktop/Universidad/CMF/Dashboard/AGFS.png")
```


Column {data-width="500"}
----------------------------------------------------------------------

### **Relación con la CMF**

Los fondos y sus administradoras son fiscalizados por la CMF y se rigen por las disposiciones de la Ley N° 20.712, las del Reglamento y, en subsidio, por las que establecen sus respectivos reglamentos internos.

La CMF tiene, para esos efectos, todas las facultades que le confiere su ley orgánica y puede examinar sin restricción alguna todos los libros, carteras y documentos mantenidos por la administradora y solicitar todos los datos y antecedentes que le permitan imponerse del estado y solvencia de la administradora, del desarrollo de la gestión de recursos efectuada por ésta y del estado de las inversiones del fondo, pudiendo ordenar las medidas que fueren necesarias, para corregir las deficiencias que encontrare.

Las administradoras están sujetas a las siguientes reglas especiales:

a)  Se forman, existen y prueban de conformidad a lo establecido en el artículo 126 de la ley N° 18.046, siéndoles aplicables los artículos 127, 128 y 129 de la misma ley.

b)  Deben incluir en su nombre la expresión "Administradora General de Fondos".

c)  Deben mantener permanentemente un patrimonio no inferior al equivalente a 10.000 unidades de fomento, el que deben acreditar y calcular en la forma que determine la CMF.

d)  Sólo pueden iniciar sus funciones una vez que hayan acreditado a satisfacción de la CMF que cumplen los requisitos legales y que cuentan con las políticas, procedimientos y controles que ésta requiera, mediante norma de carácter general, para resguardar adecuadamente los intereses de los partícipes y recursos de los fondos.

e)  Transcurrido un año contado desde su autorización de existencia, la administradora debe tener, al menos, un fondo que cumpla las condiciones relativas al patrimonio y número de partícipes establecidas en la Ley, debiendo mantener permanentemente tal condición. En caso contrario, la administradora deberá disolverse, procediéndose a su liquidación de conformidad con lo dispuesto en la Ley. El directorio de la administradora deberá comunicar este hecho a la CMF dentro de los cinco días hábiles siguientes de su ocurrencia. Adicionalmente, el directorio deberá realizar las gestiones pertinentes para que se tome nota de esta circunstancia al margen de la inscripción de la sociedad y se informe mediante publicación, por una sola vez, en el Diario Oficial.



Estadísticas por AGF {style="position:relative;"}
======================================================================

Column {.sidebar}
----------------------------------------------------------------------

```{r input1}
  selectInput(inputId = "fecha", 
              label = "Seleccione fecha", 
              choices = sort(unique(df$FM_FECHA)), 
              selected = "2022-02")
```

Column {style="height:120pc;"}
----------------------------------------------------------------------

### Activos administrados por AGF

```{r activos_agf}
renderPlotly({df %>% 
      select(FM_FECHA, RG_RAZON_SOCIAL, FM_RUN_FM, FM_ACTOT) %>%
      distinct() %>% 
      group_by(FM_FECHA, RG_RAZON_SOCIAL) %>%
      summarise(FM_ACTOT = sum(FM_ACTOT/1000000000)) %>%
      filter(FM_FECHA == input$fecha) %>%
      mutate(RG_RAZON_SOCIAL = fct_rev(fct_reorder(RG_RAZON_SOCIAL, FM_ACTOT, .desc = TRUE))) %>%
      plot_ly(x = ~FM_ACTOT, y = ~RG_RAZON_SOCIAL, hoverinfo = "x", text = "",
              marker = list(color = "rgba(102, 155, 188, 0.7)",
                            line = list(color = "black",
                                        width = 1))) %>%
      layout(xaxis = list(title = "",
                          zeroline = TRUE),
             yaxis = list(title = "",
                          ticklen = 1,
                          tickcolor = "transparent"))})
```


### Número de fondos por AGF

```{r ejemplo}
renderPlotly({
    df %>%
        select(RG_RAZON_SOCIAL, FM_RUN_FM, FM_FECHA) %>%
        distinct() %>%
        group_by(FM_FECHA, RG_RAZON_SOCIAL) %>%
        summarise(FONDOS = n_distinct(FM_RUN_FM)) %>%
        filter(FM_FECHA == input$fecha) %>%
        mutate_at("FONDOS", as.double) %>%
        mutate(RG_RAZON_SOCIAL = fct_rev(fct_reorder(RG_RAZON_SOCIAL, FONDOS, .desc = TRUE))) %>%
        plot_ly(x = ~FONDOS, y = ~RG_RAZON_SOCIAL, hoverinfo = "x", text = "",
                marker = list(color = "rgba(28, 71, 77,0.7)",
                              line = list(color = "black",
                                          width = 1))) %>%
        layout(xaxis = list(title = "",
                            zeroline = TRUE),
               yaxis = list(title = "",
                            ticklen = 1,
                            tickcolor = "transparent"))})
```

### Composición de fondos

```{r}
renderPlotly({df %>%
        select(RG_RAZON_SOCIAL, FM_RUN_FM, FM_FECHA, FO_TIPO_FONDO) %>%
        mutate(FO_TIPO_FONDO = case_when(FO_TIPO_FONDO == 1 ~ "Deuda (<90 días)",
                                         FO_TIPO_FONDO == 2 ~ "Deuda (<365 días)",
                                         FO_TIPO_FONDO == 3 ~ "Deuda (>365 días)",
                                         FO_TIPO_FONDO == 4 ~ "Mixto",
                                         FO_TIPO_FONDO == 5 ~ "Instrumentos de capitalización",
                                         FO_TIPO_FONDO == 6 ~ "Libre Inversión",
                                         FO_TIPO_FONDO == 7 ~ "Estructurado",
                                         FO_TIPO_FONDO == 8 ~ "Inversionistas calificados")) %>%
        distinct() %>%
        group_by(FM_FECHA, RG_RAZON_SOCIAL) %>%
        summarise(TIPO1 = n_distinct(FM_RUN_FM[FO_TIPO_FONDO == "Deuda (<90 días)"]),
                  TIPO2 = n_distinct(FM_RUN_FM[FO_TIPO_FONDO == "Deuda (<365 días)"]),
                  TIPO3 = n_distinct(FM_RUN_FM[FO_TIPO_FONDO == "Deuda (>365 días)"]),
                  TIPO4 = n_distinct(FM_RUN_FM[FO_TIPO_FONDO == "Mixto"]),
                  TIPO5 = n_distinct(FM_RUN_FM[FO_TIPO_FONDO == "Instrumentos de capitalización"]),
                  TIPO6 = n_distinct(FM_RUN_FM[FO_TIPO_FONDO == "Libre Inversión"]),
                  TIPO7 = n_distinct(FM_RUN_FM[FO_TIPO_FONDO == "Estructurado"]),
                  TIPO8 = n_distinct(FM_RUN_FM[FO_TIPO_FONDO == "Inversionistas calificados)"])) %>%
        mutate(TOTAL = TIPO1+TIPO2+TIPO3+TIPO4+TIPO5+TIPO6+TIPO7+TIPO8) %>%
        filter(FM_FECHA == input$fecha) %>%
        mutate_at(c("TIPO1", "TIPO2", "TIPO3", "TIPO4", "TIPO5", "TIPO6", "TIPO7", "TIPO8", "TOTAL"), as.double) %>%
        mutate(RG_RAZON_SOCIAL = fct_rev(fct_reorder(RG_RAZON_SOCIAL, TOTAL, .desc = TRUE))) %>%
        plot_ly(y = ~RG_RAZON_SOCIAL, x = ~TIPO1, hoverinfo = "x", type = "bar", text = "",
                name = "Deuda (<90 días)") %>%
        add_trace(x= ~TIPO2, name = "Deuda (<365 días)") %>%
        add_trace(x= ~TIPO3, name = "Deuda (>365 días)") %>%
        add_trace(x= ~TIPO4, name = "Mixto") %>% 
        add_trace(x= ~TIPO5, name = "Instrumentos de capitalización") %>%
        add_trace(x= ~TIPO6, name = "Libre Inversión") %>%
        add_trace(x= ~TIPO7, name = "Estructurado") %>%
        add_trace(x= ~TIPO8, name = "Inversionistas calificados") %>%
        layout(legend = list(orientation = 'h',
                             y = -0.1), 
               xaxis = list(title = "",
                            zeroline = TRUE),
               yaxis = list(title = "",
                            ticklen = 1,
                            tickcolor = "transparent"),
               barmode = "stack") %>% 
        style(legendgroup = NULL)
  })
```



Column {style="height:120pc;"}
----------------------------------------------------------------------

### Número de partícipes por AGF

```{r participes_agf}
renderPlotly({
    df %>% 
      group_by(FM_FECHA, RG_RAZON_SOCIAL) %>% 
      summarise(FM_NPART = sum(FM_NPART),
                .groups = "drop") %>%
      filter(FM_FECHA == input$fecha) %>% 
      mutate(RG_RAZON_SOCIAL = fct_rev(fct_reorder(RG_RAZON_SOCIAL, FM_NPART, .desc = TRUE))) %>%
      plot_ly(x = ~FM_NPART, y = ~RG_RAZON_SOCIAL, hoverinfo = "x", text = "",
              marker = list(color = "#3fa3ab",
                            line = list(color = "black",
                                        width = 1))) %>%
      layout(xaxis = list(title = "",
                          zeroline = TRUE),
             yaxis = list(title = "",
                          ticklen = 1,
                          tickcolor = "transparent"))})
```

### Número de fondos según moneda funcional

```{r}
renderPlotly({
  df %>%
        select(RG_RAZON_SOCIAL, FM_RUN_FM, FM_FECHA, FM_MONEDA) %>%
        distinct() %>%
        group_by(FM_FECHA, RG_RAZON_SOCIAL) %>%
        summarise(PESO = n_distinct(FM_RUN_FM[FM_MONEDA == "$$"]),
                  DOLAR = n_distinct(FM_RUN_FM[FM_MONEDA == "PROM"])) %>%
        mutate(TOTAL = PESO + DOLAR) %>%
        filter(FM_FECHA == "2022-02") %>%
        mutate_at(c("PESO", "DOLAR", "TOTAL"), as.double) %>%
        mutate(RG_RAZON_SOCIAL = fct_rev(fct_reorder(RG_RAZON_SOCIAL, TOTAL, .desc = TRUE))) %>%
        plot_ly(x = ~PESO, y = ~RG_RAZON_SOCIAL, hoverinfo = "x", type = "bar", text = "",
                name = "Peso",
                marker = list(color = "rgba(0, 105, 146, 0.7)",
                              line = list(color = "black",
                                          width = 1))) %>%
        add_trace(x = ~DOLAR, name = "Dolar", 
                  marker = list(color = "rgba(41, 241, 195, 0.7)")) %>%
        layout(xaxis = list(title = "",
                            zeroline = TRUE),
               yaxis = list(title = "",
                            ticklen = 1,
                            tickcolor = "transparent"),
               barmode = "stack",
               legend = list(orientation = "h"))
})
```

### EXPERIMENTO DINÁMICO

```{r}
renderPlotly({df %>% 
      select(FM_FECHA, RG_RAZON_SOCIAL, FM_RUN_FM, FM_ACTOT) %>%
      distinct() %>% 
      group_by(FM_FECHA, RG_RAZON_SOCIAL) %>%
      summarise(FM_ACTOT = sum(FM_ACTOT/1000000000)) %>%
      plot_ly(x = ~FM_ACTOT, y = ~RG_RAZON_SOCIAL, hoverinfo = "x", text = "", frame = ~FM_FECHA,
              marker = list(color = "rgba(102, 155, 188, 0.7)",
                            line = list(color = "black",
                                        width = 1))) %>%
      layout(xaxis = list(title = "",
                          zeroline = TRUE),
             yaxis = list(title = "",
                          ticklen = 1,
                          tickcolor = "transparent"))})
```



Estadísticas por Fondos {style="position:relative;"}
======================================================================

Column {.sidebar}
----------------------------------------------------------------------

```{r input2}
  selectInput(inputId = "fecha2", 
              label = "Seleccione fecha", 
              choices = sort(unique(df$FM_FECHA)), 
              selected = "2022-02")
```

Column {style="height:120pc;"}
----------------------------------------------------------------------

### **Activos administrados por tipo de fondo**

```{r}
renderPlotly({
    df %>% 
      select(FM_FECHA, FM_RUN_FM, FO_TIPO_FONDO, FM_ACTOT) %>% 
      distinct() %>% group_by(FM_FECHA, FO_TIPO_FONDO) %>%
      summarise(FM_ACTOT = sum(FM_ACTOT/1000000000)) %>%
      mutate(FO_TIPO_FONDO = case_when(FO_TIPO_FONDO == 1 ~ "Deuda (<90 días)",
                                          FO_TIPO_FONDO == 2 ~ "Deuda (<365 días)",
                                          FO_TIPO_FONDO == 3 ~ "Deuda (>365 días)",
                                          FO_TIPO_FONDO == 4 ~ "Mixto",
                                          FO_TIPO_FONDO == 5 ~ "Instrumentos de capitalización",
                                          FO_TIPO_FONDO == 6 ~ "Libre Inversión",
                                          FO_TIPO_FONDO == 7 ~ "Estructurado",
                                          FO_TIPO_FONDO == 8 ~ "Inversionistas calificados")) %>%
      filter(FM_FECHA == input$fecha2) %>%
      mutate(FO_TIPO_FONDO = fct_rev(fct_reorder(FO_TIPO_FONDO, FM_ACTOT, .desc = TRUE))) %>%
      plot_ly(x = ~FM_ACTOT, y = ~FO_TIPO_FONDO, hoverinfo = "x", text = "",
              marker = list(color = "rgba(214, 40, 40, 0.7)",
                            line = list(color = "black",
                                        width = 1))) %>%
      layout(xaxis = list(title = "",
                          zeroline = TRUE),
             yaxis = list(title = "",
                          ticklen = 1,
                          tickcolor = "transparent"))})
```

### **Patrimonio por tipo de fondo**

```{r}
renderPlotly({
    df %>% 
      select(FM_FECHA, FM_RUN_FM, FO_TIPO_FONDO, FM_PNETO) %>% 
      distinct() %>% group_by(FM_FECHA, FO_TIPO_FONDO) %>%
      summarise(FM_PNETO = sum(FM_PNETO/1000000000)) %>%
      mutate(FO_TIPO_FONDO = case_when(FO_TIPO_FONDO == 1 ~ "Deuda (<90 días)",
                                          FO_TIPO_FONDO == 2 ~ "Deuda (<365 días)",
                                          FO_TIPO_FONDO == 3 ~ "Deuda (>365 días)",
                                          FO_TIPO_FONDO == 4 ~ "Mixto",
                                          FO_TIPO_FONDO == 5 ~ "Instrumentos de capitalización",
                                          FO_TIPO_FONDO == 6 ~ "Libre Inversión",
                                          FO_TIPO_FONDO == 7 ~ "Estructurado",
                                          FO_TIPO_FONDO == 8 ~ "Inversionistas calificados")) %>%
      filter(FM_FECHA == input$fecha2) %>%
      mutate(FO_TIPO_FONDO = fct_rev(fct_reorder(FO_TIPO_FONDO, FM_PNETO, .desc = TRUE))) %>%
      plot_ly(x = ~FM_PNETO, y = ~FO_TIPO_FONDO, hoverinfo = "x", text = "",
              marker = list(color = "rgba(241, 227, 211, 0.7)",
                            line = list(color = "black",
                                        width = 1))) %>%
      layout(xaxis = list(title = "",
                          zeroline = TRUE),
             yaxis = list(title = "",
                          ticklen = 1,
                          tickcolor = "transparent"))})
```

### **Número de partícipes por tipo de fondo**

```{r}
renderPlotly({
    df %>% 
      group_by(FM_FECHA, FO_TIPO_FONDO) %>% 
      summarise(FM_NPART = sum(FM_NPART)) %>%
      mutate(FO_TIPO_FONDO = case_when(FO_TIPO_FONDO == 1 ~ "Deuda (<90 días)",
                                          FO_TIPO_FONDO == 2 ~ "Deuda (<365 días)",
                                          FO_TIPO_FONDO == 3 ~ "Deuda (>365 días)",
                                          FO_TIPO_FONDO == 4 ~ "Mixto",
                                          FO_TIPO_FONDO == 5 ~ "Instrumentos de capitalización",
                                          FO_TIPO_FONDO == 6 ~ "Libre Inversión",
                                          FO_TIPO_FONDO == 7 ~ "Estructurado",
                                          FO_TIPO_FONDO == 8 ~ "Inversionistas calificados")) %>%
      filter(FM_FECHA == input$fecha2) %>%
      mutate(FO_TIPO_FONDO = fct_rev(fct_reorder(FO_TIPO_FONDO, FM_NPART, .desc = TRUE))) %>%
      plot_ly(x = ~FM_NPART, y = ~FO_TIPO_FONDO, hoverinfo = "x", text = "",
              marker = list(color = "rgba(247, 127, 0, 0.7)",
                            line = list(color = "black",
                                        width = 1))) %>%
      layout(xaxis = list(title = "",
                          zeroline = TRUE),
             yaxis = list(title = "",
                          ticklen = 1,
                          tickcolor = "transparent"))})
```

### **Número de fondos según tipo**

```{r}
renderPlotly({
    df %>% 
      select(FM_FECHA, RG_RAZON_SOCIAL, FM_RUN_FM, FO_TIPO_FONDO) %>% 
      distinct() %>% mutate(unos = 1) %>% group_by(FM_FECHA, FO_TIPO_FONDO) %>%
      summarise(N = sum(unos)) %>%
      mutate(FO_TIPO_FONDO = case_when(FO_TIPO_FONDO == 1 ~ "Deuda (<90 días)",
                                          FO_TIPO_FONDO == 2 ~ "Deuda (<365 días)",
                                          FO_TIPO_FONDO == 3 ~ "Deuda (>365 días)",
                                          FO_TIPO_FONDO == 4 ~ "Mixto",
                                          FO_TIPO_FONDO == 5 ~ "Instrumentos de capitalización",
                                          FO_TIPO_FONDO == 6 ~ "Libre Inversión",
                                          FO_TIPO_FONDO == 7 ~ "Estructurado",
                                          FO_TIPO_FONDO == 8 ~ "Inversionistas calificados")) %>%
      filter(FM_FECHA == input$fecha2) %>%
      mutate(FO_TIPO_FONDO = fct_rev(fct_reorder(FO_TIPO_FONDO, N, .desc = TRUE))) %>%
      plot_ly(x = ~N, y = ~FO_TIPO_FONDO, hoverinfo = "x", text = "",
              marker = list(color = "rgba(252, 191, 73, 0.7)",
                            line = list(color = "black",
                                        width = 1))) %>%
      layout(xaxis = list(title = "",
                          zeroline = TRUE),
             yaxis = list(title = "",
                          ticklen = 1,
                          tickcolor = "transparent"))})
```

Column {style="height:120pc;"}
----------------------------------------------------------------------

### **Evolución del patrimonio por tipo de fondo**

```{r}
renderPlotly({
      df %>% 
        select(FM_FECHA, FM_PNETO, FO_TIPO_FONDO) %>% 
        group_by(FM_FECHA, FO_TIPO_FONDO) %>%
        summarise(FM_PNETO = sum(FM_PNETO)/1000000000) %>%
        pivot_wider(names_from = FO_TIPO_FONDO,
                    values_from = FM_PNETO) %>%
        rename(t1 = `1`, t2 = `2`, t3 = `3`, t4 = `4`, 
               t5 = `5`, t6 = `6`, t7 = `7`, t8 = `8`) %>%
        plot_ly(x = ~FM_FECHA, y = ~t1, name = "FM tipo 1", 
                type = "scatter", mode = "line") %>%
        add_trace(y = ~t2, name = "FM tipo 2", mode = "line", 
                  line = list(dash = "dash")) %>%
        add_trace(y = ~t3, name = "FM tipo 3", mode = "line") %>%
        add_trace(y = ~t4, name = "FM tipo 4", mode = "line", 
                  line = list(dash = "dot")) %>%
        add_trace(y = ~t5, name = "FM tipo 5", mode = "line") %>% 
        add_trace(y = ~t6, name = "FM tipo 6", mode = "line") %>%
        add_trace(y = ~t7, name = "FM tipo 7", mode = "line") %>%
        add_trace(y = ~t8, name = "FM tipo 8", mode = "line", 
                  line = list(dash = "dash")) %>%
        layout(xaxis = list(title = "",
                            zeroline = TRUE),
               yaxis = list(title = "",
                            ticklen = 1,
                            tickcolor = "transparent"),
               hovermode = "x unified",
               legend = list(orientation = "h",
                             y = -0.3)) %>%
      config(displaylogo = FALSE)})
```

### **Evolución de los activos por tipo de fondo**

```{r}
renderPlotly({
      df %>% 
        select(FM_FECHA, FM_ACTOT, FO_TIPO_FONDO) %>% 
        group_by(FM_FECHA, FO_TIPO_FONDO) %>%
        summarise(FM_ACTOT = sum(FM_ACTOT)/1000000000) %>%
        pivot_wider(names_from = FO_TIPO_FONDO,
                    values_from = FM_ACTOT) %>%
        rename(t1 = `1`, t2 = `2`, t3 = `3`, t4 = `4`, 
               t5 = `5`, t6 = `6`, t7 = `7`, t8 = `8`) %>%
        plot_ly(x = ~FM_FECHA, y = ~t1, name = "FM tipo 1", 
                type = "scatter", mode = "line") %>%
        add_trace(y = ~t2, name = "FM tipo 2", mode = "line", 
                  line = list(dash = "dash")) %>%
        add_trace(y = ~t3, name = "FM tipo 3", mode = "line") %>%
        add_trace(y = ~t4, name = "FM tipo 4", mode = "line", 
                  line = list(dash = "dot")) %>%
        add_trace(y = ~t5, name = "FM tipo 5", mode = "line") %>% 
        add_trace(y = ~t6, name = "FM tipo 6", mode = "line") %>%
        add_trace(y = ~t7, name = "FM tipo 7", mode = "line") %>%
        add_trace(y = ~t8, name = "FM tipo 8", mode = "line", 
                  line = list(dash = "dash")) %>%
        layout(xaxis = list(title = "",
                            zeroline = TRUE),
               yaxis = list(title = "",
                            ticklen = 1,
                            tickcolor = "transparent"),
               hovermode = "x unified",
               legend = list(orientation = "h",
                             y = -0.3)) %>%
      config(displaylogo = FALSE)})
```

### **Evolución de los partícipes por fondo**

```{r}
renderPlotly({
      df %>% 
        select(FM_FECHA, FM_NPART, FO_TIPO_FONDO) %>% 
        group_by(FM_FECHA, FO_TIPO_FONDO) %>%
        summarise(FM_NPART = sum(FM_NPART)) %>%
        pivot_wider(names_from = FO_TIPO_FONDO,
                    values_from = FM_NPART) %>%
        rename(t1 = `1`, t2 = `2`, t3 = `3`, t4 = `4`, 
               t5 = `5`, t6 = `6`, t7 = `7`, t8 = `8`) %>%
        plot_ly(x = ~FM_FECHA, y = ~t1, name = "FM tipo 1", 
                type = "scatter", mode = "line") %>%
        add_trace(y = ~t2, name = "FM tipo 2", mode = "line", 
                  line = list(dash = "dash")) %>%
        add_trace(y = ~t3, name = "FM tipo 3", mode = "line") %>%
        add_trace(y = ~t4, name = "FM tipo 4", mode = "line", 
                  line = list(dash = "dot")) %>%
        add_trace(y = ~t5, name = "FM tipo 5", mode = "line") %>% 
        add_trace(y = ~t6, name = "FM tipo 6", mode = "line") %>%
        add_trace(y = ~t7, name = "FM tipo 7", mode = "line") %>%
        add_trace(y = ~t8, name = "FM tipo 8", mode = "line", 
                  line = list(dash = "dash")) %>%
        layout(xaxis = list(title = "",
                            zeroline = TRUE),
               yaxis = list(title = "",
                            ticklen = 1,
                            tickcolor = "transparent"),
               hovermode = "x unified",
               legend = list(orientation = "h",
                             y = -0.3)) %>%
      config(displaylogo = FALSE)})
```

### **Evolución del número de fondos según tipo**

```{r}
renderPlotly({
      df %>%
        select(FM_FECHA, FM_RUN_FM, FO_TIPO_FONDO) %>%
        distinct() %>% mutate(unos = 1) %>% group_by(FM_FECHA, FO_TIPO_FONDO) %>%
        summarise(n = sum(unos)) %>%
        pivot_wider(names_from = FO_TIPO_FONDO,
                    values_from = n) %>%
        rename(t1 = `1`, t2 = `2`, t3 = `3`, t4 = `4`, 
               t5 = `5`, t6 = `6`, t7 = `7`, t8 = `8`) %>%
        plot_ly(x = ~FM_FECHA, y = ~t1, name = "FM tipo 1",
                type = "scatter", mode = "line") %>%
        add_trace(y = ~t2, name = "FM tipo 2", mode = "line", 
                  line = list(dash = "dash")) %>%
        add_trace(y = ~t3, name = "FM tipo 3", mode = "line") %>%
        add_trace(y = ~t4, name = "FM tipo 4", mode = "line", 
                  line = list(dash = "dot")) %>%
        add_trace(y = ~t5, name = "FM tipo 5", mode = "line") %>% 
        add_trace(y = ~t6, name = "FM tipo 6", mode = "line") %>%
        add_trace(y = ~t7, name = "FM tipo 7", mode = "line") %>%
        add_trace(y = ~t8, name = "FM tipo 8", mode = "line", 
                  line = list(dash = "dash")) %>%
        layout(xaxis = list(title = "",
                            zeroline = TRUE),
               yaxis = list(title = "",
                            ticklen = 1,
                            tickcolor = "transparent"),
               hovermode = "x unified",
               legend = list(orientation = "h",
                             y = -0.3)) %>%
    config(displaylogo = FALSE)})
```

Rentabilidad {data-navmenu="Sobre su inversión"}
======================================================================

Column {.sidebar}
----------------------------------------------------------------------

```{r input3}
selectInput(inputId = "nombre", 
            label = "Seleccione nombre del fondo", 
            choices = sort(unique(df$fo_nombre)))

selectInput(inputId = "serie",
            label = "Seleccione serie",
            choices = sort(unique(df$FM_SERIE)))
```

Column
----------------------------------------------------------------------

### **Evolución del patrimonio de su fondo**

```{r}
renderPlotly({
      df %>% 
        select(RG_RAZON_SOCIAL, FM_FECHA, fo_nombre, FM_PNETO) %>% 
        group_by(RG_RAZON_SOCIAL, fo_nombre, FM_FECHA) %>% 
        summarise(FM_PNETO = sum(FM_PNETO/1000000000)) %>% 
        filter(fo_nombre == input$nombre) %>%
        plot_ly(x = ~FM_FECHA, y = ~FM_PNETO, hoverinfo = "text", mode = "lines", 
                type = "scatter", text = ~paste0(FM_FECHA, ":", "   $", round(FM_PNETO, 2),
                                                 " miles de millones"),
                line = list(color = "#087B70" , width = 4)) %>% 
        layout(xaxis = list(title = "",
                            zeroline = TRUE),
               yaxis = list(title = "",
                            ticklen = 1,
                            tickcolor = "black"))})
```

Column
----------------------------------------------------------------------

### **Evolución del patrimonio de su serie**


```{r}
lala <- df %>% 
      select(RG_RAZON_SOCIAL, FM_FECHA, fo_nombre, FM_PNETO, FM_SERIE) %>% 
      group_by(RG_RAZON_SOCIAL, fo_nombre, FM_FECHA, FM_SERIE) %>% 
      summarise(FM_PNETO = sum(FM_PNETO/1000000000)) %>% 
      filter(fo_nombre == "FONDO MUTUO ZURICH TENDENCIAS GLOBALES") %>%
      plot_ly(x = ~FM_FECHA, y = ~FM_PNETO, )
```

```{r}
renderPlotly({
   df %>% 
      select(RG_RAZON_SOCIAL, FM_FECHA, fo_nombre, FM_PNETO, FM_SERIE) %>% 
      group_by(RG_RAZON_SOCIAL, fo_nombre, FM_FECHA, FM_SERIE) %>% 
      summarise(FM_PNETO = sum(FM_PNETO/1000000000)) %>% 
      filter(fo_nombre == input$nombre) %>%
      filter(FM_SERIE == input$serie) %>%
      plot_ly(x = ~FM_FECHA, y = ~FM_PNETO, hoverinfo = "text", mode = "line", 
              type = "scatter", text = ~paste0(FM_FECHA, ":", "   $", round(FM_PNETO, 2),
                                               " miles de millones"),
              line = list(color = "#02C39A" , width = 4)) %>% 
      layout(xaxis = list(title = "",
                          zeroline = TRUE),
             yaxis = list(title = "",
                          ticklen = 1,
                          tickcolor = "black"))})
```

TAC {data-navmenu="Sobre su inversión"}
======================================================================

Column {.sidebar}
----------------------------------------------------------------------

```{r}
selectInput(inputId = "RUN2",
            label = "Seleccione RUN del fondo",
            choices = sort(unique(tac$fo_run)),
            selected = "8011")

selectInput(inputId = "fecha3",
            label = "Seleccione año",
            choices = sort(unique(tac$ano_fondo)),
            selected = "2021")
                
```

Column
----------------------------------------------------------------------

### **Tasa Anualizada de Costos por Categoría**

```{r}
renderPlotly({
    tac %>%
      select("ano_fondo", "fam_1_afm", "tac_promedio_ponderado") %>%
      distinct() %>%
      pivot_wider(id_cols = fam_1_afm,
                  names_from = ano_fondo,
                  values_from = tac_promedio_ponderado) %>%
      plot_ly(x = ~`2021`, y = ~fam_1_afm, type = "bar", name = "2021", 
              marker = list(color = "rgba(0,0,139, 0.7)",
                            line = list(color = "black",
                                        width = 1)),
              hoverinfo = "x") %>%
      add_trace(x = ~`2022`, name = "2022", 
                marker = list(color = "rgba(0,178,238, 0.7)")) %>%
      layout(margin = list(pad = 10),
             yaxis = list(title = ""),
             xaxis = list(title = "TAC",
                          ticksuffix = "%"),
             legend = list(x = 0.8, y = 1))})    
```

### **Número de Fondos por categoría**

```{r}
renderPlotly({
   tac %>%
      select("ano_fondo", "fam_1_afm", "fo_run") %>%
      distinct() %>%
      group_by(ano_fondo, fam_1_afm) %>%
      count() %>%
      pivot_wider(id_cols = fam_1_afm,
                  values_from = n,
                  names_from = ano_fondo) %>%
      plot_ly(x = ~`2021`, y = ~fam_1_afm, type = "bar", name = "2021", 
              marker = list(color = "rgba(73, 0, 51, 0.7)",
                            line = list(color = "black",
                                        width = 1)),
              hoverinfo = "x") %>%
      add_trace(x = ~`2022`, name = "2022", 
                marker = list(color = "rgba(221, 160, 221, 0.7)")) %>%
      layout(margin = list(pad = 10),
             yaxis = list(title = ""),
             xaxis = list(title = "TAC"),
             legend = list(x = 0.8, y = 1))})
```

Column
----------------------------------------------------------------------

### **TAC del fondo vs Benchmark**

```{r}
renderPlotly({
   tac %>%
      filter(fo_run == input$RUN2) %>%
      group_by(ano_fondo, fo_run) %>%
      summarise(tac = mean(tac_total_reportado),
                benchmark = mean(tac_promedio_ponderado),
                dif = mean(dif_tac))  %>%
     pivot_longer(cols = c("tac", "benchmark", "dif"),
                  names_to = "categoria",
                  values_to = "tasas") %>% 
     pivot_wider(id_cols = c("fo_run", "categoria"),
                 names_from = ano_fondo,
                 values_from = tasas) %>%
     plot_ly(x = ~categoria, y = ~`2021`, type = "bar", name = "2021",
             marker = list(color = "rgba(72,61,139, 0.7)",
                           line = list(color = "black",
                                       width = 1)),
             hoverinfo = "y") %>%
     add_trace(y = ~`2022`, name = "2022",
               marker = list(color = "rgba(160,50,100, 0.7)")) %>%
     layout(xaxis = list(categoryorder = "array",
                         categoryarray = c("tac", "benchmark", "dif"),
                         title = "",
                         tickvals = c("tac", "benchmark", "dif"),
                         ticktext = c("TAC del fondo", "TAC Benchmark", "Diferencia")),
            yaxis = list(title = "",
                         ticksuffix = "%"))})
```

### **Series del Fondo**

```{r}
renderPlotly({
    tac %>%
      filter(fo_run == input$RUN2) %>%
      select(fm_serie, ano_fondo, tac_total_reportado) %>%
      filter(ano_fondo == input$fecha3) %>%
      plot_ly(x = ~reorder(fm_serie, tac_total_reportado), y = ~tac_total_reportado, type = "bar",
              marker = list(color = "rgba(100,149,237, 0.7)",
                            line = list(color = "black",
                                        width = 1)),
              hoverinfo = "y") %>%
      layout(xaxis = list(title = ""),
             yaxis = list(title = "",
                          ticksuffix = "%"))})
```

Datos
======================================================================

Column {.tabset}
----------------------------------------------------------------------

### **Base sobre AGF y Fondos**

```{r}
df %>% 
  select(-c("PROM", "EUR", "MXN", "PEN", "PESO")) %>%
  datatable(colnames = c("RUT AGF", "AGF", "Fecha", "RUN del fondo", "Serie del fondo", 
                         "Valor cuota", "Valor patrimonio neto", "Número de partícipes", 
                         "Moneda del fondo", "Activos administrados", "Tipo de fondo"),
            rownames = FALSE, 
            filter = "top",
            extensions = "Buttons",
            options = list(
                           pageLength = 9,
                           dom = 'Bfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf','print')))
```

### **Base sobre TAC**

```{r}
tac %>%
  datatable(colnames = c("RUN del fondo", "Serie del fondo", "Fecha", "Moneda del fondo",
                         "TAC", "Tipo de fondo", "Gasto anual en pesos", 
                         "Gasto anual en dólares", "TAC promedio por tipo",
                         "Gasto anual por tipo", "Diferencia"),
            rownames = FALSE, 
            filter = "top",
            extensions = "Buttons",
            options = list(
                           pageLength = 9,
                           dom = 'Bfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf','print')))
```
